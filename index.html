<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Entreprise</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=Urbanist:wght@300;400;500;600;700&display=swap');

* { 
  margin: 0; 
  padding: 0; 
  box-sizing: border-box; 
  font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif; 
}

body { 
  background: rgb(241,239,231); 
  color: rgb(29,75,37); 
  line-height: 1.6; 
  min-height: 100vh; 
}

.logo-container { 
  text-align: center; 
  padding: 20px 0; 
}

.logo-container img { 
  max-width: 250px; 
  height: auto; 
}

.container { 
  max-width: 900px; 
  margin: 20px auto; 
  padding: 20px; 
}

.card { 
  background: #fff; 
  border-radius: 15px; 
  padding: 20px; 
  margin-bottom: 20px; 
  box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
  transition: transform 0.2s, box-shadow 0.2s; 
}

.card:hover { 
  transform: translateY(-3px); 
  box-shadow: 0 8px 25px rgba(0,0,0,0.3); 
}

h1 { 
  font-size: 2rem; 
  color: rgb(29,75,37); 
  margin-bottom: 20px; 
  text-align: center; 
  font-family: 'Space Grotesk', serif; 
  font-weight: 700; 
}

h2 { 
  font-size: 1.4rem; 
  margin-bottom: 15px; 
  color: rgb(29,75,37); 
  font-family: 'Space Grotesk', serif; 
  font-weight: 600; 
}

input, textarea, select { 
  width: 100%; 
  padding: 12px; 
  margin-bottom: 10px; 
  border-radius: 8px; 
  border: 1px solid rgb(29,75,37); 
  background: #f5f5f5; 
  color: rgb(29,75,37); 
  font-size: 1rem; 
  font-family: 'Urbanist', sans-serif;
}

input:focus, textarea:focus, select:focus { 
  outline: none; 
  background: #e0e0d9; 
  border-color: rgb(29,75,37); 
}

textarea { 
  min-height: 100px; 
  resize: vertical; 
}

button { 
  width: 100%; 
  padding: 12px; 
  margin-top: 5px; 
  background: rgb(29,75,37); 
  color: #fff; 
  font-weight: 600; 
  font-size: 1rem; 
  border-radius: 10px; 
  border: none; 
  cursor: pointer; 
  transition: background 0.2s, transform 0.2s; 
  font-family: 'Urbanist', sans-serif;
}

button:hover { 
  background: rgb(45,115,55); 
  transform: translateY(-2px); 
}

button:disabled { 
  background: #999; 
  cursor: not-allowed; 
}

#login { 
  max-width: 400px; 
  margin: 20px auto; 
  padding: 30px; 
  background: #fff; 
  border-radius: 15px; 
  box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
  text-align: center; 
}


.hidden { 
  display: none !important; 
}

canvas { 
  max-width: 100%; 
  height: 300px; 
  display: block; 
  margin: 0 auto; 
}

.sessions-table { 
  width: 100%; 
  border-collapse: collapse; 
  margin-top: 10px; 
}

.sessions-table th, .sessions-table td { 
  padding: 8px; 
  border: 1px solid #ddd; 
  text-align: left; 
  font-size: 0.9rem; 
}

.sessions-table th { 
  background: rgb(29,75,37); 
  color: #fff; 
}

.sessions-table tr:nth-child(even) { 
  background: #f9f9f9; 
}

.btn-small { 
  width: auto; 
  padding: 5px 10px; 
  font-size: 0.85rem; 
  margin: 2px; 
}

.my-session { 
  background: #d4edda !important; 
}

.intruder { 
  background: #f8d7da !important; 
}

.blocked { 
  background: #ff4444; 
  color: #fff; 
}

.menu-toggle { 
  position: fixed; 
  top: 20px; 
  left: 20px; 
  width: 40px; 
  height: 40px; 
  background: rgb(29,75,37); 
  border-radius: 8px; 
  cursor: pointer; 
  z-index: 1001; 
  display: none; 
  flex-direction: column; 
  justify-content: center; 
  align-items: center; 
  gap: 6px; 
  transition: all 0.3s; 
}

.menu-toggle.show { 
  display: flex; 
}

.menu-toggle:hover { 
  background: rgb(45,115,55); 
}

.menu-toggle span { 
  width: 24px; 
  height: 3px; 
  background: #fff; 
  border-radius: 2px; 
  transition: all 0.3s; 
}

.menu-toggle.active span:nth-child(1) { 
  transform: rotate(45deg) translate(8px, 8px); 
}

.menu-toggle.active span:nth-child(2) { 
  opacity: 0; 
}

.menu-toggle.active span:nth-child(3) { 
  transform: rotate(-45deg) translate(7px, -7px); 
}

.sidebar { 
  position: fixed; 
  top: 0; 
  left: -300px; 
  width: 300px; 
  height: 100vh; 
  background: #fff; 
  box-shadow: 2px 0 15px rgba(0,0,0,0.2); 
  z-index: 1000; 
  transition: left 0.3s; 
  overflow-y: auto; 
}

.sidebar.active { 
  left: 0; 
}

.sidebar-header { 
  padding: 30px 20px 20px; 
  background: rgb(29,75,37); 
  color: #fff; 
}

.sidebar-header h2 { 
  font-size: 1.5rem; 
  margin: 0; 
  font-family: 'Space Grotesk', sans-serif;
}

.sidebar-menu { 
  list-style: none; 
  padding: 0; 
  margin: 0; 
}

.sidebar-menu li { 
  border-bottom: 1px solid #eee; 
}

.sidebar-menu li a { 
  display: block; 
  padding: 15px 20px; 
  color: rgb(29,75,37); 
  text-decoration: none; 
  transition: all 0.3s; 
  font-weight: 500; 
  font-family: 'Urbanist', sans-serif;
}

.sidebar-menu li a:hover, .sidebar-menu li a.active { 
  background: rgb(241,239,231); 
  color: rgb(29,75,37); 
  border-left: 4px solid rgb(29,75,37); 
}

.main-content { 
  margin-left: 0; 
  transition: margin-left 0.3s; 
  padding: 80px 20px 20px; 
}

.page-content { 
  display: none; 
}

.page-content.active { 
  display: block; 
}

.money-summary { 
  display: grid; 
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
  gap: 20px; 
  margin-bottom: 30px; 
}

.money-card { 
  background: #fff; 
  padding: 20px; 
  border-radius: 15px; 
  box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
  text-align: center; 
}

.money-card.gain { 
  border-left: 5px solid #28a745; 
}

.money-card.perte { 
  border-left: 5px solid #dc3545; 
}

.money-card.total { 
  border-left: 5px solid rgb(29,75,37); 
}

.money-card h3 { 
  font-size: 0.9rem; 
  color: #666; 
  margin-bottom: 10px; 
  text-transform: uppercase; 
  font-family: 'Urbanist', sans-serif;
}

.money-card .amount { 
  font-size: 2rem; 
  font-weight: bold; 
  font-family: 'Space Grotesk', sans-serif;
}

.money-card.gain .amount { 
  color: #28a745; 
}

.money-card.perte .amount { 
  color: #dc3545; 
}

.money-card.total .amount { 
  color: rgb(29,75,37); 
}

.transaction-list { 
  background: #fff; 
  border-radius: 15px; 
  padding: 20px; 
  box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
}

.transaction-item { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  padding: 15px; 
  border-bottom: 1px solid #eee; 
}

.transaction-item:last-child { 
  border-bottom: none; 
}

.transaction-item .info { 
  flex: 1; 
}

.transaction-item .date { 
  font-size: 0.85rem; 
  color: #666; 
}

.transaction-item .amount { 
  font-size: 1.2rem; 
  font-weight: bold; 
  font-family: 'Space Grotesk', sans-serif;
}

.transaction-item .amount.gain { 
  color: #28a745; 
}

.transaction-item .amount.perte { 
  color: #dc3545; 
}

.vetements-grid { 
  display: grid; 
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
  gap: 20px; 
  margin-top: 20px; 
}

.vetement-card { 
  background: #fff; 
  border-radius: 15px; 
  overflow: hidden; 
  box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
  transition: transform 0.3s; 
}

.vetement-card:hover { 
  transform: translateY(-5px); 
}

.vetement-card img { 
  width: 100%; 
  height: 200px; 
  object-fit: cover; 
}

.vetement-card .content { 
  padding: 15px; 
}

.vetement-card h3 { 
  margin-bottom: 10px; 
  color: rgb(29,75,37); 
  font-family: 'Space Grotesk', sans-serif;
}

.vetement-card p { 
  color: #666; 
  font-size: 0.9rem; 
  margin-bottom: 10px; 
}

.vetement-card .actions { 
  display: flex; 
  gap: 10px; 
}

.vetement-card .actions button { 
  width: auto; 
  padding: 8px 15px; 
  font-size: 0.85rem; 
}

.modal { 
  display: none; 
  position: fixed; 
  z-index: 2000; 
  left: 0; 
  top: 0; 
  width: 100%; 
  height: 100%; 
  background: rgba(0,0,0,0.5); 
}

.modal.active { 
  display: flex; 
  justify-content: center; 
  align-items: center; 
}

.modal-content { 
  background: #fff; 
  padding: 30px; 
  border-radius: 15px; 
  max-width: 500px; 
  width: 90%; 
  max-height: 90vh; 
  overflow-y: auto; 
}

.modal-content h2 { 
  margin-bottom: 20px; 
}

.image-preview { 
  display: flex; 
  gap: 10px; 
  flex-wrap: wrap; 
  margin-bottom: 15px; 
}

.image-preview img { 
  width: 100px; 
  height: 100px; 
  object-fit: cover; 
  border-radius: 8px; 
}

.vinted-card { 
  background: linear-gradient(135deg, #09B1BA 0%, #00D4BD 100%); 
  padding: 40px; 
  border-radius: 20px; 
  text-align: center; 
  color: #fff; 
  box-shadow: 0 10px 30px rgba(9, 177, 186, 0.3); 
}

.vinted-card h2 { 
  color: #fff; 
  font-size: 2rem; 
  margin-bottom: 15px; 
  font-family: 'Space Grotesk', sans-serif;
}

.vinted-card p { 
  font-size: 1.1rem; 
  margin-bottom: 25px; 
  opacity: 0.95; 
}

.vinted-card .vinted-btn { 
  display: inline-block; 
  padding: 15px 40px; 
  background: #fff; 
  color: #09B1BA; 
  font-weight: 600; 
  font-size: 1.1rem; 
  text-decoration: none; 
  border-radius: 50px; 
  transition: all 0.3s; 
  box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
  font-family: 'Urbanist', sans-serif;
}

.vinted-card .vinted-btn:hover { 
  transform: translateY(-3px); 
  box-shadow: 0 6px 20px rgba(0,0,0,0.3); 
}

.vinted-info { 
  background: #fff; 
  padding: 30px; 
  border-radius: 15px; 
  margin-top: 20px; 
  text-align: left; 
}

.vinted-info h3 { 
  color: rgb(29,75,37); 
  margin-bottom: 15px; 
  font-family: 'Space Grotesk', sans-serif; 
}

.vinted-info ul { 
  list-style: none; 
  padding-left: 0; 
}

.vinted-info li { 
  padding: 10px 0; 
  color: #666; 
  border-bottom: 1px solid #eee; 
}

.vinted-info li:before { 
  content: "‚úì "; 
  color: #09B1BA; 
  font-weight: bold; 
  margin-right: 10px; 
}

.password-container {
  position: relative;
  width: 100%;
}

.password-toggle {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  font-size: 1.2rem;
  user-select: none;
  z-index: 10;
}

.vetement-status {
  display: inline-block;
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
  margin-bottom: 10px;
}

.status-en-vente {
  background: #d4edda;
  color: #155724;
}

.status-vendu {
  background: #f8d7da;
  color: #721c24;
}
</style>
</head>
<body>

<!-- Menu Toggle (cach√© sur la page de connexion) -->
<div class="menu-toggle" id="menuToggle">
  <span></span>
  <span></span>
  <span></span>
</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h2>Menu</h2>
  </div>
  <ul class="sidebar-menu">
    <li><a href="#" data-page="dashboard" class="active">Dashboard</a></li>
    <li><a href="#" data-page="argent">Argent</a></li>
    <li><a href="#" data-page="vetements">V√™tements</a></li>
    <li><a href="#" data-page="vinted">Vinted</a></li>
    <li><a href="#" data-page="admin" id="adminMenuLink" class="hidden">Admin</a></li>
    <li><a href="#" data-page="security" id="securityMenuLink" class="hidden">S√©curit√©</a></li>
    <li><a href="#" id="logoutMenuBtn">D√©connexion</a></li>
  </ul>
</div>

<!-- Login -->
<div class="logo-container">
  <img src="logo.png" alt="Logo">
</div>
<div class="container" id="login">
  <h1>Connexion</h1>
  <input id="username" placeholder="Nom d'utilisateur" autocomplete="username">
  <div class="password-container">
    <input id="password" type="password" placeholder="Mot de passe" autocomplete="current-password">
    <span class="password-toggle" id="togglePwd">üëÅÔ∏è</span>
  </div>
  <button id="loginBtn">Se connecter</button>
</div>

<!-- Main Content -->
<div class="main-content hidden" id="mainContent">

  <!-- Page Dashboard -->
  <div class="page-content active" id="page-dashboard">
    <div class="container">
      <h1>Dashboard Entreprise</h1>
      <div class="card">
        <h2>R√©partition des parts</h2>
        <canvas id="partsChart"></canvas>
      </div>
      <div class="card">
        <h2>B√©n√©fices</h2>
        <canvas id="benefChart"></canvas>
      </div>
      <div class="card">
        <h2>Stats</h2>
        <p>Valorisation : <span id="valo"></span> ‚Ç¨</p>
        <p>Articles vendus : <span id="articles"></span></p>
      </div>
    </div>
  </div>

  <!-- Page Argent -->
  <div class="page-content" id="page-argent">
    <div class="container">
      <h1>Gestion de l'Argent</h1>
      
      <div class="money-summary">
        <div class="money-card gain">
          <h3>Gains Totaux</h3>
          <div class="amount" id="totalGains">+0 ‚Ç¨</div>
        </div>
        <div class="money-card perte">
          <h3>Pertes Totales</h3>
          <div class="amount" id="totalPertes">-0 ‚Ç¨</div>
        </div>
        <div class="money-card total">
          <h3>Solde Total</h3>
          <div class="amount" id="soldeTotal">0 ‚Ç¨</div>
        </div>
      </div>

      <div class="card" id="addTransactionCard">
        <h2>Ajouter une transaction</h2>
        <select id="transactionType">
          <option value="gain">Gain</option>
          <option value="perte">Perte</option>
        </select>
        <input id="transactionAmount" type="number" placeholder="Montant (‚Ç¨)" step="0.01">
        <input id="transactionDesc" placeholder="Description">
        <button id="addTransactionBtn">Ajouter</button>
      </div>

      <div class="transaction-list">
        <h2>Historique des transactions</h2>
        <div id="transactionsList"></div>
      </div>
    </div>
  </div>

  <!-- Page V√™tements -->
  <div class="page-content" id="page-vetements">
    <div class="container">
      <h1>V√™tements</h1>
      <div class="card">
        <button id="addVetementBtn">‚ûï Ajouter un v√™tement</button>
      </div>
      <div class="vetements-grid" id="vetementsGrid"></div>
    </div>
  </div>

  <!-- Page Vinted -->
  <div class="page-content" id="page-vinted">
    <div class="container">
      <h1>Ma Page Vinted</h1>
      <div class="vinted-card">
        <h2>Boutique Vinted</h2>
        <p>Acc√©dez √† ma boutique en ligne et d√©couvrez tous mes articles en vente</p>
        <a href="https://www.vinted.fr/member/276522486" target="_blank" class="vinted-btn">
          Acc√©der √† ma page Vinted
        </a>
      </div>
    </div>
  </div>

  <!-- Page Admin -->
  <div class="page-content" id="page-admin">
    <div class="container">
      <h1>Panel Admin</h1>
      <div class="card">
        <h2>Panel Admin</h2>
        <label>Valorisation (‚Ç¨)</label>
        <input id="newValo" type="number">
        <button id="updateValoBtn">Modifier valorisation</button>
        <label>B√©n√©fice √† ajouter (‚Ç¨)</label>
        <input id="newBenef" type="number">
        <button id="addBenefBtn">Ajouter b√©n√©fice</button>
        <label>Articles vendus √† ajouter</label>
        <input id="newArticles" type="number">
        <button id="addArticlesBtn">Ajouter ventes</button>
        <button id="resetBtn" style="margin-top:10px; background:red;">Reset donn√©es</button>
        <button id="undoBtn" style="margin-top:10px; background:orange;">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Page S√©curit√© -->
  <div class="page-content" id="page-security">
    <div class="container">
      <h1>Gestion de S√©curit√©</h1>
      <div class="card">
        <div style="background:#d4edda; padding:15px; border-radius:8px; margin-bottom:15px; border:2px solid #28a745;">
          <strong>üõ°Ô∏è VOTRE IP MA√éTRE (INBANNISSABLE) :</strong><br>
          <span id="myProtectedIP" style="font-size:1.2rem; color:#155724; font-weight:bold;"></span>
          <p style="font-size:0.85rem; margin-top:8px; color:#155724;">
            ‚úì Cette IP ne peut JAMAIS √™tre bloqu√©e<br>
            ‚úì Toute connexion "xuban" depuis une autre IP = BAN AUTO
          </p>
        </div>
        <h3>‚ö†Ô∏è Sessions Actives</h3>
        <div id="sessionsContainer"></div>
        <h3 style="margin-top:20px;">üö´ IPs Bannies</h3>
        <div id="blockedIPsContainer"></div>
        <h3 style="margin-top:20px;">Bannir une IP manuellement</h3>
        <input id="ipToBlock" placeholder="IP √† bannir">
        <button id="blockIPBtn" style="background:#ff4444;">üîí Bannir cette IP</button>
      </div>
    </div>
  </div>

</div>

<!-- Modal Ajout V√™tement -->
<div class="modal" id="vetementModal">
  <div class="modal-content">
    <h2>Ajouter un v√™tement</h2>
    <input type="file" id="vetementImages" accept="image/*" multiple style="margin-bottom:15px;">
    <div class="image-preview" id="imagePreview"></div>
    <input id="vetementTitle" placeholder="Titre du v√™tement">
    <textarea id="vetementDesc" placeholder="Description du v√™tement"></textarea>
    <button id="saveVetementBtn">Enregistrer</button>
    <button id="cancelVetementBtn" style="background:#666; margin-top:10px;">Annuler</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
const DB_PATH = "dashboard";

const firebaseConfig = {
  apiKey: "AIzaSyDjkZPkzEOpBLM498Q8URIlHYjRhdcomQo",
  authDomain: "dashboardentreprise.firebaseapp.com",
  databaseURL: "https://dashboardentreprise-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dashboardentreprise",
  storageBucket: "dashboardentreprise.appspot.com",
  messagingSenderId: "703331030101",
  appId: "1:703331030101:web:28618bf08e007ec8b230dc"
};

let db, storage;

const users = {
  xuban: { password: "admin12", role: "admin" },
  mathis: { password: "user123", role: "user" },
  enzo: { password: "user123", role: "user" },
  manon: { password: "manonlaplusbellelapluschouette", role: "user" }
};

let currentUser = null;
let currentSessionId = null;
let myIP = null;
let data = {
  valorisation: 200,
  articles: 0,
  actionnaires: [
    { nom: "Xuban", part: 50 },
    { nom: "Mathis", part: 25 },
    { nom: "Enzo", part: 25 }
  ],
  benefices: [0]
};
let transactions = [];
let vetements = [];
let history = [];
let partsChart, benefChart;
let selectedImages = [];

function init() {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  storage = firebase.storage();
  
  document.getElementById("loginBtn").onclick = login;
  document.getElementById("username").onkeydown = handleEnter;
  document.getElementById("password").onkeydown = handleEnter;
  document.getElementById("togglePwd").onclick = togglePassword;
  document.getElementById("menuToggle").onclick = toggleMenu;
  document.getElementById("logoutMenuBtn").onclick = logout;
  
  // Admin
  document.getElementById("updateValoBtn").onclick = updateValo;
  document.getElementById("addBenefBtn").onclick = addBenef;
  document.getElementById("addArticlesBtn").onclick = addArticles;
  document.getElementById("resetBtn").onclick = resetData;
  document.getElementById("undoBtn").onclick = undo;
  document.getElementById("blockIPBtn").onclick = blockIPManually;
  
  // Argent
  document.getElementById("addTransactionBtn").onclick = addTransaction;
  
  // V√™tements
  document.getElementById("addVetementBtn").onclick = () => document.getElementById("vetementModal").classList.add("active");
  document.getElementById("saveVetementBtn").onclick = saveVetement;
  document.getElementById("cancelVetementBtn").onclick = () => document.getElementById("vetementModal").classList.remove("active");
  document.getElementById("vetementImages").onchange = previewImages;
  
  // Navigation
  document.querySelectorAll('.sidebar-menu a[data-page]').forEach(link => {
    link.onclick = (e) => {
      e.preventDefault();
      navigateToPage(link.dataset.page);
      document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
      link.classList.add('active');
    };
  });
}

window.onload = init;

function toggleMenu() {
  document.getElementById("sidebar").classList.toggle("active");
  document.getElementById("menuToggle").classList.toggle("active");
}

function navigateToPage(p) {
  // V√©rifier les permissions pour les pages admin
  if((p === 'admin' || p === 'security') && (!currentUser || currentUser.role !== 'admin')) {
    alert("‚ùå Acc√®s refus√© - R√©serv√© aux administrateurs");
    return;
  }
  
  document.querySelectorAll('.page-content').forEach(x => x.classList.remove('active'));
  document.getElementById('page-' + p).classList.add('active');
  if(window.innerWidth < 768) toggleMenu();
}

function generateSessionId() {
  return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function getSimulatedIP() {
  const ua = navigator.userAgent;
  const screen = window.screen.width + 'x' + window.screen.height + 'x' + window.screen.colorDepth;
  const lang = navigator.language;
  const platform = navigator.platform;
  const cores = navigator.hardwareConcurrency || 'unknown';
  const memory = navigator.deviceMemory || 'unknown';
  const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
  let hash = 0;
  const str = ua + screen + lang + platform + cores + memory + timezone;
  for(let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  const num = Math.abs(hash);
  const a = (num >> 24) & 255;
  const b = (num >> 16) & 255;
  const c = (num >> 8) & 255;
  const d = num & 255;
  return a + '.' + b + '.' + c + '.' + d;
}

function togglePassword() {
  const p = document.getElementById("password");
  const t = document.getElementById("togglePwd");
  if(p.type === "password") {
    p.type = "text";
    t.innerText = "üôà";
  } else {
    p.type = "password";
    t.innerText = "üëÅÔ∏è";
  }
}

function handleEnter(e) {
  if(e.key === "Enter" || e.keyCode === 13) {
    e.preventDefault();
    login();
  }
}

function render() {
  document.getElementById("valo").innerText = data.valorisation;
  document.getElementById("articles").innerText = data.articles;
  const labels = data.actionnaires.map(a => a.nom + ' - ' + a.part + '% (' + (data.valorisation * a.part / 100).toFixed(0) + '‚Ç¨)');
  const values = data.actionnaires.map(a => a.part);
  if(partsChart) partsChart.destroy();
  partsChart = new Chart(document.getElementById("partsChart"), {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: ["#1a5f2c", "#2e8b46", "#4caf50"]
      }]
    }
  });
  if(benefChart) benefChart.destroy();
  benefChart = new Chart(document.getElementById("benefChart"), {
    type: 'line',
    data: {
      labels: data.benefices.map((v, i) => 'T' + (i + 1)),
      datasets: [{
        label: "B√©n√©fices (‚Ç¨)",
        data: data.benefices,
        fill: false,
        borderColor: "#1d4b25",
        tension: 0.1
      }]
    }
  });
}

function saveData() {
  db.ref(DB_PATH + '/data').set(data);
}

function addTransaction() {
  // V√©rifier que c'est un admin
  if(!currentUser || currentUser.role !== "admin") {
    alert("‚ùå Seul l'administrateur peut ajouter des transactions");
    return;
  }
  
  const type = document.getElementById("transactionType").value;
  const amount = parseFloat(document.getElementById("transactionAmount").value);
  const desc = document.getElementById("transactionDesc").value.trim();
  
  if(!amount || amount <= 0) { alert("Montant invalide"); return; }
  if(!desc) { alert("Description requise"); return; }
  
  const t = {
    id: Date.now(),
    type: type,
    amount: amount,
    description: desc,
    date: new Date().toISOString()
  };
  
  transactions.push(t);
  db.ref(DB_PATH + '/transactions').set(transactions);
  
  document.getElementById("transactionAmount").value = "";
  document.getElementById("transactionDesc").value = "";
  renderTransactions();
}

function renderTransactions() {
  const c = document.getElementById("transactionsList");
  if(transactions.length === 0) {
    c.innerHTML = '<p style="color:#666;text-align:center;padding:20px;">Aucune transaction</p>';
    updateMoneySummary();
    return;
  }
  
  let html = '';
  transactions.slice().reverse().forEach(t => {
    const date = new Date(t.date).toLocaleDateString('fr-FR');
    const sign = t.type === 'gain' ? '+' : '-';
    html += `<div class="transaction-item"><div class="info"><strong>${t.description}</strong><div class="date">${date}</div></div><div class="amount ${t.type}">${sign}${t.amount.toFixed(2)} ‚Ç¨</div></div>`;
  });
  
  c.innerHTML = html;
  updateMoneySummary();
}

function updateMoneySummary() {
  let gains = 0, pertes = 0;
  transactions.forEach(t => {
    if(t.type === 'gain') gains += t.amount;
    else pertes += t.amount;
  });
  
  const solde = gains - pertes;
  document.getElementById("totalGains").innerText = '+' + gains.toFixed(2) + ' ‚Ç¨';
  document.getElementById("totalPertes").innerText = '-' + pertes.toFixed(2) + ' ‚Ç¨';
  document.getElementById("soldeTotal").innerText = solde.toFixed(2) + ' ‚Ç¨';
}

function previewImages(e) {
  const files = Array.from(e.target.files);
  const preview = document.getElementById("imagePreview");
  preview.innerHTML = '';
  selectedImages = [];
  
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = event => {
      const img = document.createElement('img');
      img.src = event.target.result;
      preview.appendChild(img);
      selectedImages.push(event.target.result);
    };
    reader.readAsDataURL(file);
  });
}

function saveVetement() {
  const title = document.getElementById("vetementTitle").value.trim();
  const desc = document.getElementById("vetementDesc").value.trim();
  
  if(!title) { alert("Titre requis"); return; }
  if(selectedImages.length === 0) { alert("Ajoutez au moins une image"); return; }
  
  const v = {
    id: Date.now(),
    title: title,
    description: desc,
    images: selectedImages,
    status: 'en-vente', // Par d√©faut en vente
    date: new Date().toISOString()
  };
  
  vetements.push(v);
  db.ref(DB_PATH + '/vetements').set(vetements);
  
  document.getElementById("vetementTitle").value = "";
  document.getElementById("vetementDesc").value = "";
  document.getElementById("vetementImages").value = "";
  document.getElementById("imagePreview").innerHTML = "";
  selectedImages = [];
  document.getElementById("vetementModal").classList.remove("active");
  
  renderVetements();
}

function renderVetements() {
  const grid = document.getElementById("vetementsGrid");
  if(vetements.length === 0) {
    grid.innerHTML = '<p style="color:#666;text-align:center;padding:20px;">Aucun v√™tement ajout√©</p>';
    return;
  }
  
  let html = '';
  vetements.forEach(v => {
    const statusClass = v.status === 'vendu' ? 'status-vendu' : 'status-en-vente';
    const statusText = v.status === 'vendu' ? '‚úÖ Vendu' : 'üè∑Ô∏è En vente';
    const toggleBtnText = v.status === 'vendu' ? 'üîÑ Remettre en vente' : '‚úÖ Marquer vendu';
    const toggleBtnColor = v.status === 'vendu' ? '#28a745' : '#ff9800';
    
    html += `<div class="vetement-card">
      <img src="${v.images[0]}" alt="${v.title}">
      <div class="content">
        <span class="vetement-status ${statusClass}">${statusText}</span>
        <h3>${v.title}</h3>
        <p>${v.description || 'Pas de description'}</p>
        <div class="actions">
          <button onclick="toggleVetementStatus(${v.id})" style="background:${toggleBtnColor};">${toggleBtnText}</button>
          <button onclick="deleteVetement(${v.id})" style="background:#dc3545;">Supprimer</button>
        </div>
      </div>
    </div>`;
  });
  
  grid.innerHTML = html;
}

function deleteVetement(id) {
  if(!confirm("Supprimer ce v√™tement ?")) return;
  vetements = vetements.filter(v => v.id !== id);
  db.ref(DB_PATH + '/vetements').set(vetements);
  renderVetements();
}

function toggleVetementStatus(id) {
  const vetement = vetements.find(v => v.id === id);
  if(!vetement) return;
  
  vetement.status = vetement.status === 'vendu' ? 'en-vente' : 'vendu';
  db.ref(DB_PATH + '/vetements').set(vetements);
  renderVetements();
}

function getMasterIP(cb) {
  db.ref(DB_PATH + '/masterIP').once("value", s => {
    cb(s.exists() ? s.val().ip : null);
  });
}

function setMasterIP(ip) {
  db.ref(DB_PATH + '/masterIP').set({ip: ip, setAt: Date.now(), setBy: "xuban"});
}

function checkIfIPBlocked(ip, cb) {
  getMasterIP(m => {
    if(m && ip === m) {
      cb(false);
      return;
    }
    db.ref(DB_PATH + '/blockedIPs/' + ip.replace(/\./g, '_')).once("value", s => {
      const b = s.val();
      cb(b && b.blocked);
    });
  });
}

function autoBanIntruder(ip, username) {
  db.ref(DB_PATH + '/blockedIPs/' + ip.replace(/\./g, '_')).set({
    blocked: true,
    blockedAt: Date.now(),
    blockedBy: "AUTO-BAN",
    reason: 'Tentative connexion "' + username + '" depuis IP non autoris√©e'
  });
}

function renderSessions() {
  if(!currentUser || currentUser.role !== "admin") {
    alert("‚ùå Acc√®s non autoris√©");
    navigateToPage('dashboard');
    return;
  }
  getMasterIP(masterIP => {
    db.ref(DB_PATH + '/sessions').once("value", snapshot => {
      const sessions = snapshot.val() || {};
      const container = document.getElementById("sessionsContainer");
      let html = '<table class="sessions-table"><thead><tr><th>User</th><th>IP</th><th>Connexion</th><th>Statut</th><th>Actions</th></tr></thead><tbody>';
      let hasActive = false;
      for(let sid in sessions) {
        const s = sessions[sid];
        if(s.active) {
          hasActive = true;
          const time = new Date(s.loginTime).toLocaleString('fr-FR');
          const isCurrent = sid === currentSessionId;
          const isMaster = s.ip === masterIP;
          const isIntruder = s.username === 'xuban' && !isMaster;
          let status = '', rowClass = '';
          if(isCurrent && isMaster) { status = 'üõ°Ô∏è VOUS (IP Ma√Ætre)'; rowClass = 'my-session'; }
          else if(isMaster) { status = 'üõ°Ô∏è IP Ma√Ætre'; rowClass = 'my-session'; }
          else if(isIntruder) { status = 'üö® INTRUS BANNI'; rowClass = 'intruder'; }
          else if(isCurrent) { status = '‚úÖ Vous'; }
          else { status = 'üë§ Autre'; }
          html += '<tr class="' + rowClass + '"><td><strong>' + s.username + '</strong></td><td>' + s.ip + '</td><td>' + time + '</td><td><strong>' + status + '</strong></td><td>';
          if(!isCurrent) html += '<button class="btn-small" onclick="kickSession(\'' + sid + '\')" style="background:#ff9800;">‚èèÔ∏è Kick</button>';
          if(!isMaster) html += '<button class="btn-small" onclick="blockIP(\'' + s.ip + '\',\'' + sid + '\')" style="background:#dc3545;">üîí BAN</button>';
          else html += '<span style="color:#28a745;font-size:0.8rem;font-weight:bold;">üõ°Ô∏è PROT√âG√âE</span>';
          html += '</td></tr>';
        }
      }
      html += '</tbody></table>';
      container.innerHTML = hasActive ? html : '<p style="color:#666;">Aucune session active</p>';
    });
  });
}

function renderBlockedIPs() {
  if(!currentUser || currentUser.role !== "admin") {
    alert("‚ùå Acc√®s non autoris√©");
    navigateToPage('dashboard');
    return;
  }
  db.ref(DB_PATH + '/blockedIPs').once("value", snapshot => {
    const blocked = snapshot.val() || {};
    const container = document.getElementById("blockedIPsContainer");
    let html = '<table class="sessions-table"><thead><tr><th>IP</th><th>Date</th><th>Raison</th><th>Actions</th></tr></thead><tbody>';
    let hasBlocked = false;
    for(let ip in blocked) {
      if(blocked[ip].blocked) {
        hasBlocked = true;
        const time = new Date(blocked[ip].blockedAt).toLocaleString('fr-FR');
        const reason = blocked[ip].reason || "Manuelle";
        const realIP = ip.replace(/_/g, '.');
        html += '<tr class="blocked"><td><strong>' + realIP + '</strong></td><td>' + time + '</td><td>' + reason + '</td><td><button class="btn-small" onclick="unblockIP(\'' + ip + '\')" style="background:#4caf50;">‚úÖ D√©bloquer</button></td></tr>';
      }
    }
    html += '</tbody></table>';
    container.innerHTML = hasBlocked ? html : '<p style="color:#666;">Aucune IP bannie</p>';
  });
}

function kickSession(sid) {
  if(confirm("‚èèÔ∏è D√©connecter cette session ?")) {
    db.ref(DB_PATH + '/sessions/' + sid).update({active: false, kickedAt: Date.now()}).then(() => {
      alert("‚úÖ Session d√©connect√©e");
      renderSessions();
    });
  }
}

function blockIP(ip, sid) {
  getMasterIP(masterIP => {
    if(ip === masterIP) { alert("‚ùå Impossible de bannir l'IP Ma√Ætre !"); return; }
    if(confirm('üîí BANNIR l\'IP ' + ip + ' ?')) {
      db.ref(DB_PATH + '/blockedIPs/' + ip.replace(/\./g, '_')).set({
        blocked: true,
        blockedAt: Date.now(),
        blockedBy: currentUser.username,
        reason: 'Banni manuellement'
      }).then(() => {
        db.ref(DB_PATH + '/sessions').once("value", snapshot => {
          const sessions = snapshot.val() || {};
          for(let s in sessions) {
            if(sessions[s].ip === ip && sessions[s].active) {
              db.ref(DB_PATH + '/sessions/' + s).update({active: false, kickedAt: Date.now()});
            }
          }
        });
        alert('‚úÖ IP ' + ip + ' bannie !');
        renderBlockedIPs();
        renderSessions();
      });
    }
  });
}

function blockIPManually() {
  const ip = document.getElementById("ipToBlock").value.trim();
  if(!ip) { alert("Entrez une IP"); return; }
  getMasterIP(masterIP => {
    if(ip === masterIP) { alert("‚ùå Impossible de bannir l'IP Ma√Ætre !"); return; }
    if(confirm('üîí Bannir ' + ip + ' ?')) {
      db.ref(DB_PATH + '/blockedIPs/' + ip.replace(/\./g, '_')).set({
        blocked: true,
        blockedAt: Date.now(),
        blockedBy: currentUser.username,
        reason: "Blocage manuel"
      }).then(() => {
        alert('‚úÖ IP ' + ip + ' bannie !');
        document.getElementById("ipToBlock").value = "";
        renderBlockedIPs();
      });
    }
  });
}

function unblockIP(ip) {
  const realIP = ip.replace(/_/g, '.');
  if(confirm('‚úÖ D√©bloquer ' + realIP + ' ?')) {
    db.ref(DB_PATH + '/blockedIPs/' + ip).remove().then(() => {
      alert('‚úÖ IP ' + realIP + ' d√©bloqu√©e');
      renderBlockedIPs();
    });
  }
}

function monitorSession() {
  if(!currentSessionId) return;
  db.ref(DB_PATH + '/sessions/' + currentSessionId).on("value", snapshot => {
    const s = snapshot.val();
    if(s && !s.active) {
      alert("‚ö†Ô∏è Vous avez √©t√© d√©connect√© !");
      forceLogout();
    }
  });
}

function forceLogout() {
  // D√©tacher les listeners Firebase
  if(currentSessionId) {
    db.ref(DB_PATH + '/sessions/' + currentSessionId).off();
  }
  db.ref(DB_PATH + '/data').off();
  db.ref(DB_PATH + '/transactions').off();
  db.ref(DB_PATH + '/vetements').off();
  if(currentUser && currentUser.role === "admin") {
    db.ref(DB_PATH + '/sessions').off();
    db.ref(DB_PATH + '/blockedIPs').off();
  }
  
  // D√©truire les graphiques
  if(partsChart) {
    partsChart.destroy();
    partsChart = null;
  }
  if(benefChart) {
    benefChart.destroy();
    benefChart = null;
  }
  
  // R√©initialiser les variables
  currentUser = null;
  currentSessionId = null;
  myIP = null;
  
  // R√©initialiser l'interface
  document.getElementById("mainContent").classList.add("hidden");
  document.getElementById("login").classList.remove("hidden");
  document.getElementById("sidebar").classList.remove("active");
  document.getElementById("menuToggle").classList.remove("show");
  document.getElementById("menuToggle").classList.remove("active");
  
  // Revenir √† la page dashboard
  document.querySelectorAll('.page-content').forEach(x => x.classList.remove('active'));
  document.getElementById('page-dashboard').classList.add('active');
  
  // R√©activer le lien dashboard dans le menu
  document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
  document.querySelector('.sidebar-menu a[data-page="dashboard"]').classList.add('active');
  
  // Masquer les liens admin
  document.getElementById("adminMenuLink").classList.add("hidden");
  document.getElementById("securityMenuLink").classList.add("hidden");
  
  // Vider les champs de connexion
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
}

function initRealtimeDatabase() {
  db.ref(DB_PATH + '/data').on("value", snapshot => {
    if(snapshot.exists()) {
      data = snapshot.val();
      render();
    } else {
      db.ref(DB_PATH + '/data').set(data);
    }
  });
  
  db.ref(DB_PATH + '/transactions').on("value", snapshot => {
    transactions = snapshot.exists() ? snapshot.val() : [];
    renderTransactions();
  });
  
  db.ref(DB_PATH + '/vetements').on("value", snapshot => {
    vetements = snapshot.exists() ? snapshot.val() : [];
    renderVetements();
  });
  
  if(currentUser.role === "admin") {
    db.ref(DB_PATH + '/sessions').on("value", () => renderSessions());
    db.ref(DB_PATH + '/blockedIPs').on("value", () => renderBlockedIPs());
  }
}

function login() {
  const u = document.getElementById("username").value.toLowerCase().trim();
  const p = document.getElementById("password").value;
  if(!users[u] || users[u].password !== p) { alert("‚ùå Identifiants incorrects"); return; }
  myIP = getSimulatedIP();
  checkIfIPBlocked(myIP, isBlocked => {
    if(isBlocked) {
      alert("üö´ ACC√àS REFUS√â - IP BANNIE\n\n" + myIP);
      return;
    }
    currentUser = users[u];
    currentUser.username = u;
    currentSessionId = generateSessionId();
    if(currentUser.role === "admin" && u === "xuban") {
      getMasterIP(masterIP => {
        if(!masterIP) {
          setMasterIP(myIP);
          document.getElementById("myProtectedIP").innerText = myIP;
          proceedLogin();
        } else {
          document.getElementById("myProtectedIP").innerText = masterIP;
          if(myIP !== masterIP) {
            autoBanIntruder(myIP, u);
            alert("üö® ACC√àS REFUS√â\n\nCe compte ne peut √™tre utilis√© que depuis l'IP Ma√Ætre.\n\nVotre IP a √©t√© bannie.\n\nIP: " + myIP);
            return;
          } else {
            proceedLogin();
          }
        }
      });
    } else {
      proceedLogin();
    }
  });
}

function proceedLogin() {
  // D'abord, d√©sactiver toutes les anciennes sessions de cet utilisateur
  db.ref(DB_PATH + '/sessions').once("value", snapshot => {
    const sessions = snapshot.val() || {};
    const updates = {};
    
    for(let sid in sessions) {
      if(sessions[sid].username === currentUser.username && sessions[sid].active) {
        updates[sid + '/active'] = false;
        updates[sid + '/replacedAt'] = Date.now();
      }
    }
    
    // Appliquer les mises √† jour puis cr√©er la nouvelle session
    if(Object.keys(updates).length > 0) {
      db.ref(DB_PATH + '/sessions').update(updates).then(() => {
        createNewSession();
      });
    } else {
      createNewSession();
    }
  });
}

function createNewSession() {
  db.ref(DB_PATH + '/sessions/' + currentSessionId).set({
    username: currentUser.username,
    ip: myIP,
    loginTime: Date.now(),
    active: true,
    userAgent: navigator.userAgent.substring(0, 100)
  });
  
  document.getElementById("login").classList.add("hidden");
  document.getElementById("mainContent").classList.remove("hidden");
  document.getElementById("menuToggle").classList.add("show");
  
  if(currentUser.role === "admin") {
    document.getElementById("adminMenuLink").classList.remove("hidden");
    document.getElementById("securityMenuLink").classList.remove("hidden");
    renderSessions();
    renderBlockedIPs();
  }
  
  initRealtimeDatabase();
  updateUIPermissions();
  monitorSession();
}

function updateUIPermissions() {
  if(currentUser && currentUser.role === "admin") {
    document.getElementById("addTransactionCard").style.display = "block";
  } else {
    document.getElementById("addTransactionCard").style.display = "none";
  }
}

function logout() {
  if(currentSessionId) {
    db.ref(DB_PATH + '/sessions/' + currentSessionId).update({active: false, logoutTime: Date.now()});
  }
  forceLogout();
}

function updateValo() {
  if(!currentUser || currentUser.role !== "admin") return;
  const val = Number(document.getElementById("newValo").value);
  if(isNaN(val) || val < 0) { alert("Valeur invalide"); return; }
  history.push(JSON.stringify(data));
  data.valorisation = val;
  document.getElementById("newValo").value = "";
  saveData();
}

function addBenef() {
  if(!currentUser || currentUser.role !== "admin") return;
  const val = Number(document.getElementById("newBenef").value);
  if(isNaN(val)) { alert("Valeur invalide"); return; }
  history.push(JSON.stringify(data));
  const last = data.benefices[data.benefices.length - 1];
  data.benefices.push(last + val);
  document.getElementById("newBenef").value = "";
  saveData();
}

function addArticles() {
  if(!currentUser || currentUser.role !== "admin") return;
  const val = Number(document.getElementById("newArticles").value);
  if(isNaN(val) || val < 0) { alert("Valeur invalide"); return; }
  history.push(JSON.stringify(data));
  data.articles += val;
  document.getElementById("newArticles").value = "";
  saveData();
}

function resetData() {
  if(!currentUser || currentUser.role !== "admin") return;
  if(!confirm("‚ö†Ô∏è RESET COMPLET DE TOUT LE SITE ?")) return;
  if(!confirm("‚ö†Ô∏è‚ö†Ô∏è DERNI√àRE CONFIRMATION - Toutes les donn√©es (v√™tements, transactions, b√©n√©fices) seront supprim√©es !")) return;
  
  history.push(JSON.stringify(data));
  
  // Reset data
  data = {
    valorisation: 200,
    articles: 0,
    actionnaires: [{nom: "Xuban", part: 50}, {nom: "Mathis", part: 25}, {nom: "Enzo", part: 25}],
    benefices: [0]
  };
  
  // Reset transactions
  transactions = [];
  db.ref(DB_PATH + '/transactions').set([]);
  
  // Reset v√™tements
  vetements = [];
  db.ref(DB_PATH + '/vetements').set([]);
  
  saveData();
  alert("‚úÖ Toutes les donn√©es ont √©t√© r√©initialis√©es !");
}

function undo() {
  if(!currentUser || currentUser.role !== "admin") return;
  if(history.length === 0) { alert("Rien √† annuler"); return; }
  data = JSON.parse(history.pop());
  saveData();
}
</script>
</body>
</html>