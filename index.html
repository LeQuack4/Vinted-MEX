<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Entreprise</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif; }
body { background: rgb(241,239,231); color: rgb(29,75,37); line-height: 1.6; min-height:100vh; }
.logo-container { text-align:center; padding:20px 0; }
.logo-container img { max-width:250px; height:auto; }
.container { max-width:900px; margin:20px auto; padding:20px; }
.card { background:#fff; border-radius:15px; padding:20px; margin-bottom:20px; box-shadow:0 4px 15px rgba(0,0,0,0.2); transition: transform 0.2s, box-shadow 0.2s; }
.card:hover { transform:translateY(-3px); box-shadow:0 8px 25px rgba(0,0,0,0.3); }
h1 { font-size:2rem; color: rgb(29,75,37); margin-bottom:20px; text-align:center; }
h2 { font-size:1.4rem; margin-bottom:15px; color: rgb(29,75,37); }
input { width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid rgb(29,75,37); background:#f5f5f5; color: rgb(29,75,37); font-size:1rem; }
input:focus { outline:none; background:#e0e0d9; border-color: rgb(29,75,37); }
button { width:100%; padding:12px; margin-top:5px; background: rgb(29,75,37); color:#fff; font-weight:bold; font-size:1rem; border-radius:10px; border:none; cursor:pointer; transition: background 0.2s, transform 0.2s; }
button:hover { background: rgb(45,115,55); transform: translateY(-2px); }
button:disabled { background: #999; cursor: not-allowed; }
#login { max-width:400px; margin:50px auto; padding:30px; background:#fff; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.3); text-align:center; }
.hidden { display:none !important; }
canvas { max-width:100%; height:300px; display:block; margin:0 auto; }
.sessions-table { width:100%; border-collapse: collapse; margin-top:10px; }
.sessions-table th, .sessions-table td { padding:8px; border:1px solid #ddd; text-align:left; font-size:0.9rem; }
.sessions-table th { background: rgb(29,75,37); color:#fff; }
.sessions-table tr:nth-child(even) { background:#f9f9f9; }
.btn-small { width:auto; padding:5px 10px; font-size:0.85rem; margin:2px; }
.my-session { background:#d4edda !important; }
.intruder { background:#f8d7da !important; }
.blocked { background:#ff4444; color:#fff; }
.loading { color:#666; font-size:0.9rem; margin-top:10px; }
</style>
</head>
<body>

<div class="logo-container">
  <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
</div>

<div class="container" id="login">
  <h1>Connexion</h1>
  <input id="username" placeholder="Nom d'utilisateur">
  <div style="position: relative;">
    <input id="password" type="password" placeholder="Mot de passe">
    <span id="togglePwd" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:1.2rem;">üëÅÔ∏è</span>
  </div>
  <button id="loginBtn">Se connecter</button>
</div>

<div class="container hidden" id="dashboard">
  <h1>Dashboard Entreprise</h1>

  <div class="card">
    <h2>R√©partition des parts</h2>
    <canvas id="partsChart"></canvas>
  </div>

  <div class="card">
    <h2>B√©n√©fices</h2>
    <canvas id="benefChart"></canvas>
  </div>

  <div class="card">
    <h2>Stats</h2>
    <p>Valorisation : <span id="valo"></span> ‚Ç¨</p>
    <p>Articles vendus : <span id="articles"></span></p>
  </div>

  <div class="card hidden" id="adminPanel">
    <h2>Panel Admin</h2>
    <label>Valorisation (‚Ç¨)</label>
    <input id="newValo" type="number">
    <button id="updateValoBtn">Modifier valorisation</button>
    <label>B√©n√©fice √† ajouter (‚Ç¨)</label>
    <input id="newBenef" type="number">
    <button id="addBenefBtn">Ajouter b√©n√©fice</button>
    <label>Articles vendus √† ajouter</label>
    <input id="newArticles" type="number">
    <button id="addArticlesBtn">Ajouter ventes</button>
    <button id="resetBtn" style="margin-top:10px; background:red;">Reset donn√©es</button>
    <button id="undoBtn" style="margin-top:10px; background:orange;">Annuler</button>
  </div>

  <div class="card hidden" id="securityPanel">
    <h2>üîí Gestion de S√©curit√©</h2>
    <div style="background:#d4edda; padding:15px; border-radius:8px; margin-bottom:15px; border:2px solid #28a745;">
      <strong>üõ°Ô∏è VOTRE IP MA√éTRE (INBANNISSABLE) :</strong><br>
      <span id="myProtectedIP" style="font-size:1.2rem; color:#155724; font-weight:bold;"></span>
      <p style="font-size:0.85rem; margin-top:8px; color:#155724;">
        ‚úì Cette IP ne peut JAMAIS √™tre bloqu√©e<br>
        ‚úì Toute connexion "xuban" depuis une autre IP = BAN AUTO
      </p>
    </div>
    <h3>‚ö†Ô∏è Sessions Actives</h3>
    <div id="sessionsContainer"></div>
    <h3 style="margin-top:20px;">üö´ IPs Bannies</h3>
    <div id="blockedIPsContainer"></div>
    <h3 style="margin-top:20px;">Bannir une IP manuellement</h3>
    <input id="ipToBlock" placeholder="IP √† bannir">
    <button id="blockIPBtn" style="background:#ff4444;">üîí Bannir cette IP</button>
  </div>

  <button id="logoutBtn" style="background:#666; margin-top:20px;">Se d√©connecter</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
const CURRENT_VERSION = "1.0.4";
const DB_PATH = "dashboard";

const firebaseConfig = {
  apiKey: "AIzaSyDjkZPkzEOpBLM498Q8URIlHYjRhdcomQo",
  authDomain: "dashboardentreprise.firebaseapp.com",
  databaseURL: "https://dashboardentreprise-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dashboardentreprise",
  storageBucket: "dashboardentreprise.appspot.com",
  messagingSenderId: "703331030101",
  appId: "1:703331030101:web:28618bf08e007ec8b230dc"
};

let db;

const users = {
  xuban: { password:"admin12", role:"admin" },
  mathis: { password:"user123", role:"user" },
  enzo: { password:"user123", role:"user" },
  manon: { password:"manonlaplusbellelapluschouette", role:"user" }
};

let currentUser = null;
let currentSessionId = null;
let myIP = null;
let data = {
  valorisation:200,
  articles:0,
  actionnaires:[
    {nom:"Xuban", part:50},
    {nom:"Mathis", part:25},
    {nom:"Enzo", part:25}
  ],
  benefices:[0]
};
let history = [];
let partsChart, benefChart;

function init() {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  
  document.getElementById("loginBtn").onclick = login;
  document.getElementById("username").onkeydown = handleEnter;
  document.getElementById("password").onkeydown = handleEnter;
  document.getElementById("togglePwd").onclick = togglePassword;
  document.getElementById("updateValoBtn").onclick = updateValo;
  document.getElementById("addBenefBtn").onclick = addBenef;
  document.getElementById("addArticlesBtn").onclick = addArticles;
  document.getElementById("resetBtn").onclick = resetData;
  document.getElementById("undoBtn").onclick = undo;
  document.getElementById("blockIPBtn").onclick = blockIPManually;
  document.getElementById("logoutBtn").onclick = logout;
}

window.onload = init;

function generateSessionId(){
  return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function getSimulatedIP(){
  const ua = navigator.userAgent;
  const screen = window.screen.width + 'x' + window.screen.height + 'x' + window.screen.colorDepth;
  const lang = navigator.language;
  const platform = navigator.platform;
  const cores = navigator.hardwareConcurrency || 'unknown';
  const memory = navigator.deviceMemory || 'unknown';
  const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
  let hash = 0;
  const str = ua + screen + lang + platform + cores + memory + timezone;
  for(let i = 0; i < str.length; i++){
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  const num = Math.abs(hash);
  const a = (num >> 24) & 255;
  const b = (num >> 16) & 255;
  const c = (num >> 8) & 255;
  const d = num & 255;
  return a + '.' + b + '.' + c + '.' + d;
}

function togglePassword(){
  const pwdInput = document.getElementById("password");
  const toggleIcon = document.getElementById("togglePwd");
  if(pwdInput.type === "password"){
    pwdInput.type = "text";
    toggleIcon.innerText = "üôà";
  } else {
    pwdInput.type = "password";
    toggleIcon.innerText = "üëÅÔ∏è";
  }
}

function handleEnter(e){
  if(e.key === "Enter" || e.keyCode === 13){
    e.preventDefault();
    login();
  }
}

function render(){
  document.getElementById("valo").innerText = data.valorisation;
  document.getElementById("articles").innerText = data.articles;
  const labels = data.actionnaires.map(a => a.nom + ' - ' + a.part + '% (' + (data.valorisation*a.part/100).toFixed(0) + '‚Ç¨)');
  const values = data.actionnaires.map(a => a.part);
  if(partsChart) partsChart.destroy();
  partsChart = new Chart(document.getElementById("partsChart"),{type:'pie',data:{labels:labels,datasets:[{data:values,backgroundColor:["#1a5f2c","#2e8b46","#4caf50"]}]}});
  if(benefChart) benefChart.destroy();
  benefChart = new Chart(document.getElementById("benefChart"),{type:'line',data:{labels:data.benefices.map((v,i)=>'T'+(i+1)),datasets:[{label:"B√©n√©fices (‚Ç¨)",data:data.benefices,fill:false,borderColor:"#1d4b25",tension:0.1}]}});
}

function saveData(){
  db.ref(DB_PATH + '/data').set(data);
}

function getMasterIP(callback){
  db.ref(DB_PATH + '/masterIP').once("value", snapshot => {
    callback(snapshot.exists() ? snapshot.val().ip : null);
  });
}

function setMasterIP(ip){
  db.ref(DB_PATH + '/masterIP').set({ip: ip, setAt: Date.now(), setBy: "xuban"});
  console.log("üõ°Ô∏è IP Ma√Ætre d√©finie:", ip);
}

function checkIfIPBlocked(ip, callback){
  getMasterIP(masterIP => {
    if(masterIP && ip === masterIP){
      callback(false);
      return;
    }
    db.ref(DB_PATH + '/blockedIPs/' + ip.replace(/\./g, '_')).once("value", snapshot => {
      const blocked = snapshot.val();
      callback(blocked && blocked.blocked);
    });
  });
}

function autoBanIntruder(ip, username){
  db.ref(DB_PATH + '/blockedIPs/' + ip.replace(/\./g, '_')).set({blocked: true, blockedAt: Date.now(), blockedBy: "SYST√àME AUTO-BAN", reason: 'Tentative connexion "' + username + '" depuis IP non autoris√©e'});
  console.log("üö® AUTO-BAN pour IP:", ip);
}

function renderSessions(){
  if(!currentUser || currentUser.role !== "admin") return;
  getMasterIP(masterIP => {
    db.ref(DB_PATH + '/sessions').once("value", snapshot => {
      const sessions = snapshot.val() || {};
      const container = document.getElementById("sessionsContainer");
      let html = '<table class="sessions-table"><thead><tr><th>User</th><th>IP</th><th>Connexion</th><th>Statut</th><th>Actions</th></tr></thead><tbody>';
      let hasActive = false;
      for(let sid in sessions){
        const s = sessions[sid];
        if(s.active){
          hasActive = true;
          const time = new Date(s.loginTime).toLocaleString('fr-FR');
          const isCurrent = sid === currentSessionId;
          const isMaster = s.ip === masterIP;
          const isIntruder = s.username === 'xuban' && !isMaster;
          let status = '', rowClass = '';
          if(isCurrent && isMaster){ status = 'üõ°Ô∏è VOUS (IP Ma√Ætre)'; rowClass = 'my-session'; }
          else if(isMaster){ status = 'üõ°Ô∏è IP Ma√Ætre'; rowClass = 'my-session'; }
          else if(isIntruder){ status = 'üö® INTRUS BANNI'; rowClass = 'intruder'; }
          else if(isCurrent){ status = '‚úÖ Vous'; }
          else { status = 'üë§ Autre'; }
          html += '<tr class="' + rowClass + '"><td><strong>' + s.username + '</strong></td><td>' + s.ip + '</td><td>' + time + '</td><td><strong>' + status + '</strong></td><td>';
          if(!isCurrent) html += '<button class="btn-small" onclick="kickSession(\'' + sid + '\')" style="background:#ff9800;">‚èèÔ∏è Kick</button>';
          if(!isMaster) html += '<button class="btn-small" onclick="blockIP(\'' + s.ip + '\', \'' + sid + '\')" style="background:#dc3545;">üîí BAN</button>';
          else html += '<span style="color:#28a745; font-size:0.8rem; font-weight:bold;">üõ°Ô∏è PROT√âG√âE</span>';
          html += '</td></tr>';
        }
      }
      html += '</tbody></table>';
      container.innerHTML = hasActive ? html : '<p style="color:#666;">Aucune session active</p>';
    });
  });
}

function renderBlockedIPs(){
  if(!currentUser || currentUser.role !== "admin") return;
  db.ref(DB_PATH + '/blockedIPs').once("value", snapshot => {
    const blocked = snapshot.val() || {};
    const container = document.getElementById("blockedIPsContainer");
    let html = '<table class="sessions-table"><thead><tr><th>IP</th><th>Date</th><th>Raison</th><th>Actions</th></tr></thead><tbody>';
    let hasBlocked = false;
    for(let ip in blocked){
      if(blocked[ip].blocked){
        hasBlocked = true;
        const time = new Date(blocked[ip].blockedAt).toLocaleString('fr-FR');
        const reason = blocked[ip].reason || "Manuelle";
        const realIP = ip.replace(/_/g, '.');
        html += '<tr class="blocked"><td><strong>' + realIP + '</strong></td><td>' + time + '</td><td>' + reason + '</td><td><button class="btn-small" onclick="unblockIP(\'' + ip + '\')" style="background:#4caf50;">‚úÖ D√©bloquer</button></td></tr>';
      }
    }
    html += '</tbody></table>';
    container.innerHTML = hasBlocked ? html : '<p style="color:#666;">Aucune IP bannie</p>';
  });
}

function kickSession(sid){
  if(confirm("‚èèÔ∏è D√©connecter cette session ?")){
    db.ref(DB_PATH + '/sessions/' + sid).update({active: false, kickedAt: Date.now()}).then(() => {
      alert("‚úÖ Session d√©connect√©e");
      renderSessions();
    });
  }
}

function blockIP(ip, sid){
  getMasterIP(masterIP => {
    if(ip === masterIP){ alert("‚ùå Impossible de bannir l'IP Ma√Ætre !"); return; }
    if(confirm('üîí BANNIR l\'IP ' + ip + ' ?')){
      db.ref(DB_PATH + '/blockedIPs/' + ip.replace(/\./g, '_')).set({blocked: true, blockedAt: Date.now(), blockedBy: currentUser.username, reason: 'Banni manuellement'}).then(() => {
        db.ref(DB_PATH + '/sessions').once("value", snapshot => {
          const sessions = snapshot.val() || {};
          for(let s in sessions){
            if(sessions[s].ip === ip && sessions[s].active){
              db.ref(DB_PATH + '/sessions/' + s).update({active: false, kickedAt: Date.now()});
            }
          }
        });
        alert('‚úÖ IP ' + ip + ' bannie !');
        renderBlockedIPs();
        renderSessions();
      });
    }
  });
}

function blockIPManually(){
  const ip = document.getElementById("ipToBlock").value.trim();
  if(!ip){ alert("Entrez une IP"); return; }
  getMasterIP(masterIP => {
    if(ip === masterIP){ alert("‚ùå Impossible de bannir l'IP Ma√Ætre !"); return; }
    if(confirm('üîí Bannir ' + ip + ' ?')){
      db.ref(DB_PATH + '/blockedIPs/' + ip.replace(/\./g, '_')).set({blocked: true, blockedAt: Date.now(), blockedBy: currentUser.username, reason: "Blocage manuel"}).then(() => {
        alert('‚úÖ IP ' + ip + ' bannie !');
        document.getElementById("ipToBlock").value = "";
        renderBlockedIPs();
      });
    }
  });
}

function unblockIP(ip){
  const realIP = ip.replace(/_/g, '.');
  if(confirm('‚úÖ D√©bloquer ' + realIP + ' ?')){
    db.ref(DB_PATH + '/blockedIPs/' + ip).remove().then(() => {
      alert('‚úÖ IP ' + realIP + ' d√©bloqu√©e');
      renderBlockedIPs();
    });
  }
}

function monitorSession(){
  if(!currentSessionId) return;
  db.ref(DB_PATH + '/sessions/' + currentSessionId).on("value", snapshot => {
    const s = snapshot.val();
    if(s && !s.active){
      alert("‚ö†Ô∏è Vous avez √©t√© d√©connect√© !");
      forceLogout();
    }
  });
}

function forceLogout(){
  if(currentSessionId) db.ref(DB_PATH + '/sessions/' + currentSessionId).off();
  currentUser = null;
  currentSessionId = null;
  myIP = null;
  document.getElementById("dashboard").classList.add("hidden");
  document.getElementById("adminPanel").classList.add("hidden");
  document.getElementById("securityPanel").classList.add("hidden");
  document.getElementById("login").classList.remove("hidden");
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
}

function initRealtimeDatabase(){
  db.ref(DB_PATH + '/data').on("value", snapshot=>{
    if(snapshot.exists()){
      data = snapshot.val();
      render();
    } else {
      db.ref(DB_PATH + '/data').set(data);
    }
  });
  if(currentUser.role === "admin"){
    db.ref(DB_PATH + '/sessions').on("value", () => renderSessions());
    db.ref(DB_PATH + '/blockedIPs').on("value", () => renderBlockedIPs());
  }
}

function login(){
  const u = document.getElementById("username").value.toLowerCase().trim();
  const p = document.getElementById("password").value;
  if(!users[u] || users[u].password !== p){ alert("‚ùå Identifiants incorrects"); return; }
  myIP = getSimulatedIP();
  console.log("üîç IP:", myIP);
  checkIfIPBlocked(myIP, isBlocked => {
    if(isBlocked){
      alert("üö´ ACC√àS REFUS√â - IP BANNIE\n\n" + myIP);
      return;
    }
    currentUser = users[u];
    currentUser.username = u;
    currentSessionId = generateSessionId();
    if(currentUser.role === "admin" && u === "xuban"){
      getMasterIP(masterIP => {
        if(!masterIP){
          setMasterIP(myIP);
          document.getElementById("myProtectedIP").innerText = myIP;
          proceedLogin();
        } else {
          document.getElementById("myProtectedIP").innerText = masterIP;
          if(myIP !== masterIP){
            console.warn("üö® INTRUS ! xuban depuis IP non-master");
            autoBanIntruder(myIP, u);
            alert("üö® ACC√àS REFUS√â\n\nCe compte ne peut √™tre utilis√© que depuis l'IP Ma√Ætre.\n\nVotre IP a √©t√© bannie.\n\nIP: " + myIP);
            return;
          } else {
            proceedLogin();
          }
        }
      });
    } else {
      proceedLogin();
    }
  });
}

function proceedLogin(){
  db.ref(DB_PATH + '/sessions/' + currentSessionId).set({username: currentUser.username, ip: myIP, loginTime: Date.now(), active: true, userAgent: navigator.userAgent.substring(0, 100)});
  document.getElementById("login").classList.add("hidden");
  document.getElementById("dashboard").classList.remove("hidden");
  if(currentUser.role === "admin"){
    document.getElementById("adminPanel").classList.remove("hidden");
    document.getElementById("securityPanel").classList.remove("hidden");
    renderSessions();
    renderBlockedIPs();
  }
  initRealtimeDatabase();
  monitorSession();
}

function logout(){
  if(currentSessionId){
    db.ref(DB_PATH + '/sessions/' + currentSessionId).update({active: false, logoutTime: Date.now()});
  }
  forceLogout();
}

function updateValo(){
  if(!currentUser || currentUser.role!=="admin") return;
  const val = Number(document.getElementById("newValo").value);
  if(isNaN(val) || val<0){ alert("Valeur invalide"); return; }
  history.push(JSON.stringify(data));
  data.valorisation=val;
  document.getElementById("newValo").value="";
  saveData();
}

function addBenef(){
  if(!currentUser || currentUser.role!=="admin") return;
  const val = Number(document.getElementById("newBenef").value);
  if(isNaN(val)){ alert("Valeur invalide"); return; }
  history.push(JSON.stringify(data));
  const last = data.benefices[data.benefices.length-1];
  data.benefices.push(last+val);
  document.getElementById("newBenef").value="";
  saveData();
}

function addArticles(){
  if(!currentUser || currentUser.role!=="admin") return;
  const val = Number(document.getElementById("newArticles").value);
  if(isNaN(val) || val<0){ alert("Valeur invalide"); return; }
  history.push(JSON.stringify(data));
  data.articles += val;
  document.getElementById("newArticles").value="";
  saveData();
}

function resetData(){
  if(!currentUser || currentUser.role!=="admin") return;
  if(!confirm("‚ö†Ô∏è RESET COMPLET ?")) return;
  history.push(JSON.stringify(data));
  data = {valorisation:200, articles:0, actionnaires:[{nom:"Xuban", part:50},{nom:"Mathis", part:25},{nom:"Enzo", part:25}], benefices:[0]};
  saveData();
}

function undo(){
  if(!currentUser || currentUser.role!=="admin") return;
  if(history.length === 0){ alert("Rien √† annuler"); return; }
  data = JSON.parse(history.pop());
  saveData();
}
</script>
</body>
</html>